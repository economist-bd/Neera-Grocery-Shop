<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neera Grocery Shop</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2E7D32">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3724/3724720.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- CSS Start --- */
        :root { --primary: #2E7D32; --accent: #FF5722; --dark: #1b1f23; --light: #ffffff; --gray: #f5f5f5; }
        body { font-family: 'Hind Siliguri', sans-serif; margin: 0; padding: 0; background-color: var(--gray); padding-bottom: 70px; overscroll-behavior-y: contain; }
        
        /* Header & Nav */
        header { background: var(--primary); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .logo { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .cart-icon { position: relative; cursor: pointer; }
        .badge { position: absolute; top: -5px; right: -8px; background: var(--accent); color: white; border-radius: 50%; padding: 2px 5px; font-size: 10px; }
        
        /* Carousel & Cards */
        .carousel { position: relative; width: 100%; height: 200px; overflow: hidden; background: #ddd; }
        .carousel img { width: 100%; height: 100%; object-fit: cover; transition: opacity 1s ease-in-out; }
        .section-title { padding: 15px 15px 5px; font-size: 1.1rem; font-weight: 700; color: var(--dark); }
        .scroll-container { display: flex; overflow-x: auto; gap: 10px; padding: 10px 15px; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .card { min-width: 150px; max-width: 150px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .card img { width: 100%; height: 110px; object-fit: cover; }
        .card-body { padding: 8px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 0.95rem; font-weight: 600; margin: 0; line-height: 1.2; }
        .discount-tag { position: absolute; top: 5px; right: 5px; background: var(--accent); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .btn-add { background: var(--primary); color: white; border: none; width: 100%; padding: 6px; border-radius: 5px; margin-top: 5px; cursor: pointer; }
        .btn-cancel { background: #d32f2f; }

        /* Modals & Sidebar */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; border-radius: 10px; padding: 20px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; }
        .sidebar { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: white; z-index: 3000; transition: 0.3s; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
        .sidebar.open { left: 0; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; display: block; color: #333; text-decoration: none; cursor: pointer; }
        
        /* Admin & Forms */
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .order-card { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #fff; }
        .status-pending { color: orange; font-weight: bold; }
        .status-delivered { color: green; font-weight: bold; }
        .status-cancelled { color: red; font-weight: bold; }
        
        /* Floating Ad */
        .ad-popup { position: fixed; top: 20px; right: 20px; width: 200px; background: white; border: 2px solid var(--accent); border-radius: 10px; z-index: 5000; display: none; padding: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .ad-close { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; line-height: 25px; cursor: pointer; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; font-size: 0.8rem; color: #666; cursor: pointer; text-decoration: none;}
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div style="background: var(--primary); padding: 20px; color: white;">
            <h3>Neera Shop</h3>
            <p id="menuUserEmail">Guest</p>
        </div>
        <div class="menu-item" onclick="toggleSidebar(); window.scrollTo(0,0);">Home</div>
        <div class="menu-item" onclick="openOrderHistory()">My Orders</div>
        <div class="menu-item" onclick="openModal('adminModal'); loadAdminData();" id="adminLink" style="display:none; color: var(--primary); font-weight:bold;">Admin Panel</div>
        <div class="menu-item" onclick="handleLogout()" id="logoutBtn" style="display:none;">Logout</div>
    </div>
    <div class="modal" id="sidebarOverlay" onclick="toggleSidebar()" style="z-index: 2500; background: rgba(0,0,0,0);"></div>

    <header>
        <div class="logo">
            <i class="fas fa-bars" onclick="toggleSidebar()" style="cursor: pointer; margin-right: 10px;"></i>
            Neera Grocery
        </div>
        <div class="cart-icon" onclick="openCart()">
            <i class="fas fa-shopping-cart"></i>
            <span class="badge" id="cartCount">0</span>
        </div>
    </header>

    <div id="adPopup" class="ad-popup">
        <div class="ad-close" onclick="closeAd()">&times;</div>
        <small style="color:red; font-weight:bold;">⚡ Special Offer!</small>
        <img id="adImg" src="" style="width:100%; height:100px; object-fit:cover; margin:5px 0;">
        <h4 id="adTitle" style="margin:5px 0; font-size:0.9rem;"></h4>
        <button class="btn-add" onclick="goToAdProduct()">View</button>
    </div>

    <div class="carousel" id="heroCarousel">
        <img id="carouselImg" src="https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=800&q=80">
    </div>

    <div class="section-title">Categories</div>
    <div class="scroll-container" id="categoryList"></div>

    <div class="section-title"><span><i class="fas fa-tags" style="color:var(--accent)"></i> Offers</span></div>
    <div class="scroll-container" id="offerList"></div>

    <div class="section-title">All Products</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px;" id="allProductsList"></div>
    <div style="height: 50px;"></div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="window.scrollTo(0,0)"><i class="fas fa-home"></i><br>Home</div>
        <div class="nav-item" onclick="openOrderHistory()"><i class="fas fa-list-alt"></i><br>Orders</div>
        <a href="https://wa.me/8801715247588" class="nav-item"><i class="fab fa-whatsapp"></i><br>Chat</a>
    </nav>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('productModal')">&times;</span>
            <img id="modalImg" src="" style="width:100%; height:200px; object-fit:cover; border-radius:10px;">
            <h2 id="modalTitle" style="margin:10px 0;"></h2>
            <h3 id="modalPrice" style="color:var(--primary);"></h3>
            <p id="modalDesc" style="color:#555; white-space:pre-wrap;"></p>
            <button class="btn-add" onclick="addToCartFromModal()" style="padding:15px; font-size:1.1rem;">Add to Cart</button>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cartModal')">&times;</span>
            <h2>Your Cart</h2>
            <div id="cartItems" style="max-height: 250px; overflow-y: auto;"></div>
            <div style="margin-top:10px; font-weight:bold; display:flex; justify-content:space-between;">
                <span>Total:</span> <span id="cartTotal">0</span> BDT
            </div>
            <div id="checkoutSection" style="margin-top:15px;">
                <h3>Checkout</h3>
                <input type="text" id="orderName" placeholder="Name" required>
                <input type="text" id="orderPhone" placeholder="Phone" required>
                <textarea id="orderAddress" placeholder="Address" required></textarea>
                <button class="btn-add" style="background:#1b1f23; margin-top:10px;" onclick="processCheckout()">Confirm Order (COD)</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-btn" onclick="closeModal('authModal')">&times;</span>
            <h2>Login / Signup</h2>
            <input type="email" id="authEmail" placeholder="Email">
            <input type="password" id="authPass" placeholder="Password">
            <button class="btn-add" onclick="handleAuth()">Submit</button>
            <p id="authMsg" style="color:red; margin-top:5px;"></p>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('historyModal')">&times;</span>
            <h2>My Orders</h2>
            <div id="orderList" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="closeModal('adminModal')">&times;</span>
            <h2>Admin Dashboard</h2>
            
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <button onclick="showAdminTab('Prod')" class="btn-add" style="flex:1;">Products</button>
                <button onclick="showAdminTab('Ord')" class="btn-add" style="flex:1; background:var(--accent);">Orders</button>
                <button onclick="showAdminTab('Set')" class="btn-add" style="flex:1; background:#555;">Settings</button>
            </div>

            <div id="adminProdTab">
                <h3>Product Manager</h3>
                <input type="hidden" id="pId">
                <input type="text" id="pName" placeholder="Product Name">
                <input type="number" id="pPrice" placeholder="Price">
                <input type="number" id="pDiscount" placeholder="Discount %">
                <select id="pCatSelect"></select>
                <input type="file" onchange="encodeImage(this, 'pImgBase64')">
                <input type="hidden" id="pImgBase64">
                <textarea id="pDesc" rows="3" placeholder="Description"></textarea>
                <div style="display:flex; gap:10px; margin:5px 0;">
                    <label><input type="checkbox" id="pIsPop"> Popular</label>
                    <label><input type="checkbox" id="pIsSpecial"> Special</label>
                </div>
                <button class="btn-add" onclick="saveProduct()">Save Product</button>
                <button class="btn-add" style="background:#777;" onclick="resetAdminForm()">Clear</button>
            </div>

            <div id="adminOrdTab" style="display:none;">
                <h3>All Customer Orders</h3>
                <div id="adminOrderList" style="max-height:300px; overflow-y:auto; background:#f9f9f9; padding:5px;">
                    Loading orders...
                </div>
            </div>

            <div id="adminSetTab" style="display:none;">
                <h3>Settings</h3>
                <p><b>Add Category:</b></p>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newCatName" placeholder="New Category">
                    <button class="btn-add" style="width:80px;" onclick="addCategory()">Add</button>
                </div>
                <p style="margin-top:15px;"><b>Update Banner:</b></p>
                <input type="file" onchange="uploadBanner(this)">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmhCAUKAu6wptvSazTIzXzqB1hsaPEcNk",
            authDomain: "neera-d1df0.firebaseapp.com",
            projectId: "neera-d1df0",
            storageBucket: "neera-d1df0.firebasestorage.app",
            messagingSenderId: "745022493052",
            appId: "1:745022493052:web:4f57819eeca48090bc14f9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let products = [];
        let categories = ['Grocery', 'Fruits', 'Vegetables'];
        let currentUser = null;
        let adInterval = null;

        // --- UI UTILS ---
        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
        
        // **FIXED ADMIN TAB FUNCTION**
        window.showAdminTab = (tabName) => {
            // Safe check for elements before styling
            const tabs = ['adminProdTab', 'adminOrdTab', 'adminSetTab'];
            tabs.forEach(t => {
                const el = document.getElementById(t);
                if(el) el.style.display = 'none';
            });
            const target = document.getElementById('admin' + tabName + 'Tab');
            if(target) target.style.display = 'block';
        };

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if(user) {
                document.getElementById('menuUserEmail').innerText = user.email;
                document.getElementById('logoutBtn').style.display = 'block';
                // Admin check
                if(user.email === 'neera.shop@gmail.com') {
                    document.getElementById('adminLink').style.display = 'block';
                }
            } else {
                document.getElementById('menuUserEmail').innerText = 'Guest';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('adminLink').style.display = 'none';
            }
        });

        window.handleAuth = async () => {
            const e = document.getElementById('authEmail').value;
            const p = document.getElementById('authPass').value;
            try {
                await signInWithEmailAndPassword(auth, e, p);
                closeModal('authModal');
                if(cart.length > 0) openCart();
            } catch (err) {
                try {
                    await createUserWithEmailAndPassword(auth, e, p);
                    closeModal('authModal');
                    if(cart.length > 0) openCart();
                } catch (err2) {
                    alert(err2.message);
                }
            }
        };

        window.handleLogout = () => signOut(auth).then(() => window.location.reload());

        // --- PRODUCTS ---
        const renderApp = () => {
            onSnapshot(collection(db, "products"), (snap) => {
                products = [];
                snap.forEach(d => products.push({id: d.id, ...d.data()}));
                products.sort((a,b) => (a.name||"").localeCompare(b.name||""));

                let all='', pop='', off='';
                products.forEach(p => {
                    const card = createCard(p);
                    all += card;
                    if(p.isPop) pop += card;
                    if(p.isSpecial || p.discount > 0) off += card;
                });

                document.getElementById('allProductsList').innerHTML = all;
                document.getElementById('offerList').innerHTML = off;
                startAdLoop();
            });

            onSnapshot(collection(db, "settings"), (snap) => {
                snap.forEach(d => {
                    if(d.id === 'categories') {
                        categories = d.data().list || [];
                        renderCategories();
                    }
                    if(d.id === 'banners' && d.data().images) {
                        document.getElementById('carouselImg').src = d.data().images[0];
                    }
                });
            });
        };

        function createCard(p) {
            const img = p.image || 'https://placehold.co/150';
            const price = p.discount ? Math.round(p.price * (1 - p.discount/100)) : p.price;
            const dispPrice = p.discount ? `<s style="color:#999">${p.price}</s> ৳${price}` : `৳${price}`;
            const tag = p.discount ? `<div class="discount-tag">-${p.discount}%</div>` : '';

            return `
            <div class="card">
                ${tag}
                <img src="${img}" onclick="showDetails('${p.id}')">
                <div class="card-body">
                    <div class="card-title" onclick="showDetails('${p.id}')">${p.name}</div>
                    <div style="color:var(--primary); font-weight:bold;">${dispPrice}</div>
                    <button class="btn-add" onclick="addToCart('${p.id}')">Add</button>
                    ${currentUser?.email === 'neera.shop@gmail.com' ? `<small onclick="editProduct('${p.id}')" style="color:blue;cursor:pointer;text-align:center;">Edit</small>` : ''}
                </div>
            </div>`;
        }

        function renderCategories() {
            const html = categories.map(c => `<div style="min-width:80px; text-align:center; padding:10px; background:white; border-radius:10px; box-shadow:0 2px 5px #ddd;">${c}</div>`).join('');
            document.getElementById('categoryList').innerHTML = html;
            document.getElementById('pCatSelect').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // --- ADMIN FUNCTIONS ---
        window.loadAdminData = () => {
            // This loads ALL orders for the Admin Panel
            onSnapshot(collection(db, "orders"), (snap) => {
                const list = document.getElementById('adminOrderList');
                if(!list) return;
                
                let orders = [];
                snap.forEach(d => orders.push({id: d.id, ...d.data()}));
                orders.sort((a,b) => new Date(b.date) - new Date(a.date));

                if(orders.length === 0) {
                    list.innerHTML = "No orders found.";
                    return;
                }

                list.innerHTML = orders.map(o => `
                    <div class="order-card">
                        <small>${new Date(o.date).toLocaleString()}</small><br>
                        <strong>${o.name} (${o.phone})</strong><br>
                        Address: ${o.address}<br>
                        Items: ${o.items.map(i=>i.name).join(', ')} (Total: ৳${o.total})<br>
                        <select onchange="updateOrderStatus('${o.id}', this.value)" style="background:${o.status==='Pending'?'#fff3cd':'#d4edda'}">
                            <option value="Pending" ${o.status=='Pending'?'selected':''}>Pending</option>
                            <option value="Delivered" ${o.status=='Delivered'?'selected':''}>Delivered</option>
                            <option value="Cancelled" ${o.status=='Cancelled'?'selected':''}>Cancelled</option>
                        </select>
                    </div>
                `).join('');
            });
        };

        window.updateOrderStatus = (oid, status) => updateDoc(doc(db, "orders", oid), { status });

        window.saveProduct = async () => {
            const id = document.getElementById('pId').value;
            const data = {
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                discount: document.getElementById('pDiscount').value || 0,
                category: document.getElementById('pCatSelect').value,
                description: document.getElementById('pDesc').value,
                isPop: document.getElementById('pIsPop').checked,
                isSpecial: document.getElementById('pIsSpecial').checked
            };
            const img = document.getElementById('pImgBase64').value;
            if(img) data.image = img;

            try {
                if(id) await updateDoc(doc(db, "products", id), data);
                else await addDoc(collection(db, "products"), data);
                alert("Saved!");
                resetAdminForm();
            } catch(e) { alert("Error: "+e.message); }
        };

        window.encodeImage = (el, tid) => {
            if(el.files && el.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Simple Resize
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 400 / img.width;
                        canvas.width = 400;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        document.getElementById(tid).value = canvas.toDataURL('image/jpeg', 0.7);
                    }
                };
                reader.readAsDataURL(el.files[0]);
            }
        };

        window.resetAdminForm = () => {
            document.getElementById('pId').value = '';
            document.querySelectorAll('#adminProdTab input').forEach(i => {
                if(i.type==='text'||i.type==='number') i.value='';
                if(i.type==='checkbox') i.checked=false;
            });
            document.getElementById('pImgBase64').value = '';
        };

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            document.getElementById('pId').value = p.id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pDiscount').value = p.discount;
            document.getElementById('pDesc').value = p.description;
            document.getElementById('pIsPop').checked = p.isPop;
            document.getElementById('pIsSpecial').checked = p.isSpecial;
            openModal('adminModal');
            showAdminTab('Prod');
        };

        window.addCategory = async () => {
            const val = document.getElementById('newCatName').value;
            if(val) {
                categories.push(val);
                await setDoc(doc(db, "settings", "categories"), { list: categories });
                alert("Category Added!");
            }
        };

        window.uploadBanner = (el) => {
            if(el.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    setDoc(doc(db, "settings", "banners"), { images: [e.target.result] }, {merge:true});
                    alert("Banner Updated!");
                };
                reader.readAsDataURL(el.files[0]);
            }
        };

        // --- CART & ORDERS ---
        window.addToCart = (id) => {
            const p = products.find(x => x.id === id);
            if(p) { cart.push(p); updateCartUI(); }
        };

        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.length;
            localStorage.setItem('cart', JSON.stringify(cart));
            
            const list = document.getElementById('cartItems');
            let total = 0;
            list.innerHTML = cart.map((item, i) => {
                const price = item.discount ? Math.round(item.price*(1-item.discount/100)) : item.price;
                total += parseInt(price);
                return `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
                    <span>${item.name}</span>
                    <span>৳${price} <i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="removeFromCart(${i})"></i></span>
                </div>`;
            }).join('');
            document.getElementById('cartTotal').innerText = total;
        }

        window.removeFromCart = (i) => { cart.splice(i,1); updateCartUI(); };
        window.openCart = () => { updateCartUI(); openModal('cartModal'); };

        window.processCheckout = async () => {
            if(!currentUser) { closeModal('cartModal'); openModal('authModal'); return; }
            const name = document.getElementById('orderName').value;
            const phone = document.getElementById('orderPhone').value;
            const addr = document.getElementById('orderAddress').value;
            
            if(!name || !phone || !addr || cart.length === 0) return alert("Fill all details & add items!");
            
            const order = {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                name, phone, address: addr,
                items: cart,
                total: document.getElementById('cartTotal').innerText,
                status: 'Pending',
                date: new Date().toISOString()
            };
            
            try {
                await addDoc(collection(db, "orders"), order);
                alert("Order Placed!");
                cart = []; updateCartUI(); closeModal('cartModal');
            } catch(e) { alert(e.message); }
        };

        window.openOrderHistory = async () => {
            if(!currentUser) { openModal('authModal'); return; }
            openModal('historyModal');
            const list = document.getElementById('orderList');
            list.innerHTML = 'Loading...';
            
            const q = query(collection(db, "orders"), where("userId", "==", currentUser.uid));
            const snaps = await getDocs(q);
            
            if(snaps.empty) { list.innerHTML = "No orders found."; return; }
            
            let myOrders = [];
            snaps.forEach(d => myOrders.push({id: d.id, ...d.data()}));
            myOrders.sort((a,b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = myOrders.map(o => `
                <div class="order-card">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${new Date(o.date).toLocaleDateString()}</b>
                        <span class="status-${o.status.toLowerCase()}">${o.status}</span>
                    </div>
                    <p>${o.items.map(i=>i.name).join(', ')}</p>
                    <p>Total: ৳${o.total}</p>
                    ${o.status!=='Delivered' && o.status!=='Cancelled' ? `<button class="btn-add btn-cancel" onclick="cancelOrder('${o.id}')">Cancel</button>` : ''}
                </div>
            `).join('');
        };

        window.cancelOrder = async (oid) => {
            if(confirm("Cancel Order?")) {
                await updateDoc(doc(db, "orders", oid), { status: 'Cancelled' });
                openOrderHistory();
            }
        };

        // --- EXTRAS ---
        window.showDetails = (id) => {
            const p = products.find(x => x.id === id);
            document.getElementById('modalImg').src = p.image || '';
            document.getElementById('modalTitle').innerText = p.name;
            const price = p.discount ? Math.round(p.price * (1 - p.discount/100)) : p.price;
            document.getElementById('modalPrice').innerText = `৳${price}`;
            document.getElementById('modalDesc').innerText = p.description || '';
            window.currPid = id;
            openModal('productModal');
        };
        window.addToCartFromModal = () => { if(window.currPid) addToCart(window.currPid); closeModal('productModal'); };

        function startAdLoop() {
            if(adInterval) clearInterval(adInterval);
            const ads = products.filter(p => p.isSpecial || p.isPop);
            if(ads.length === 0) return;
            adInterval = setInterval(() => {
                if(document.querySelector('.modal[style*="flex"]')) return;
                const p = ads[Math.floor(Math.random() * ads.length)];
                const popup = document.getElementById('adPopup');
                document.getElementById('adImg').src = p.image || '';
                document.getElementById('adTitle').innerText = p.name;
                popup.dataset.pid = p.id;
                popup.style.display = 'block';
                setTimeout(() => popup.style.display = 'none', 6000);
            }, 15000);
        }
        window.closeAd = () => document.getElementById('adPopup').style.display = 'none';
        window.goToAdProduct = () => { showDetails(document.getElementById('adPopup').dataset.pid); closeAd(); };

        renderApp();
        updateCartUI();
    </script>
</body>
</html>
